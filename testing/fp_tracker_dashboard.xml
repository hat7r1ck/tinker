<dashboard version="1.1" theme="dark">
  <label>SOC False Positive Tracker</label>
  <description>FP tracking for SOC analysts -- entity lookback, KV exclusion check, submission, and tuning ticket generation</description>

  <!-- ============================================================
       UPDATED fp_tracker.csv SCHEMA (place in lookups directory):
       timestamp, analyst, rule_name, ioc_value, ioc_type, ioc_field,
       risk_object, xsoar_case, reason, count, t2_validation_needed,
       tuning_ticket, status

       REMOVED: rule_id (not used operationally)
       ADDED: ioc_field (maps to KV field - what field is being excluded)
              xsoar_case (MC incident ID for tuning ticket justification)
       ============================================================ -->

  <!-- ============================================================
       BASE SEARCH: All FP tracker data, shared across panels
       ============================================================ -->
  <search id="base_fp_data">
    <query>| inputlookup fp_tracker.csv
| eval timestamp_epoch=timestamp,
       timestamp=strftime(timestamp, "%Y-%m-%d %H:%M:%S")</query>
    <earliest>-30d@d</earliest>
    <latest>now</latest>
    <refresh>300</refresh>
    <refreshType>delay</refreshType>
  </search>

  <!-- ============================================================
       GLOBAL INPUT: Entity search drives the entire context section
       Analyst pastes risk_object from XSOAR or Mission Control here
       ============================================================ -->
  <fieldset submitButton="true" autoRun="false">
    <input type="text" token="search_entity" searchWhenChanged="false">
      <label>Risk Object / Entity Lookup (paste hostname or username from XSOAR case)</label>
      <default></default>
    </input>
  </fieldset>

  <!-- ============================================================
       ROW 1: KPI PANELS
       ============================================================ -->
  <row>
    <panel>
      <title>Entries Added Today</title>
      <single>
        <search base="base_fp_data">
          <query>| where timestamp_epoch >= relative_time(now(), "@d")
| stats count as total</query>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53a051","0x53a051"]</option>
        <option name="rangeValues">[0]</option>
        <option name="underLabel">TODAY</option>
        <option name="useColors">1</option>
        <option name="height">120</option>
      </single>
    </panel>

    <panel>
      <title>Total FP Entries</title>
      <single>
        <search base="base_fp_data">
          <query>| stats count as total</query>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
        <option name="rangeValues">[0]</option>
        <option name="underLabel">ALL TIME</option>
        <option name="useColors">1</option>
        <option name="height">120</option>
      </single>
    </panel>

    <panel>
      <title>Rules &gt;= 10 FPs This Week</title>
      <single>
        <search base="base_fp_data">
          <query>| where timestamp_epoch >= relative_time(now(), "-7d@d") AND status="open"
| stats count by rule_name
| where count >= 10
| stats count as total</query>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[0,3]</option>
        <option name="underLabel">TUNE CANDIDATES</option>
        <option name="useColors">1</option>
        <option name="height">120</option>
      </single>
    </panel>

    <panel>
      <title>Pending T2 Review</title>
      <single>
        <search base="base_fp_data">
          <query>| where t2_validation_needed=1 AND status="open"
| stats count as total</query>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xf8be34"]</option>
        <option name="rangeValues">[0,1]</option>
        <option name="underLabel">T2 QUEUE</option>
        <option name="useColors">1</option>
        <option name="height">120</option>
      </single>
    </panel>
  </row>

  <!-- ============================================================
       ROW 2: ENTITY CONTEXT HEADER
       Only visible when search_entity is populated
       ============================================================ -->
  <row depends="$search_entity$">
    <panel>
      <html>
        <h2 style="color:#f8be34; margin:0; padding:10px 0 5px 0; border-bottom:2px solid #f8be34;">
          Entity Context: $search_entity$
        </h2>
        <p style="color:#dc4e41; margin:5px 0 2px 0; font-size:0.85em; font-weight:bold;">
          KNOWN ISSUE: Benign Positive dispositions are currently falling into the malicious bucket in truth table (not getting suppression). Use False Positive as the reliable FP signal. BP counts shown here for volume awareness only.
        </p>
        <p style="color:#999; margin:2px 0 0 0; font-size:0.85em;">
          Disposition history from notable index, existing KV exclusions, and FP tracker entries for this entity.
        </p>
      </html>
    </panel>
  </row>

  <!-- ============================================================
       ROW 3: DISPOSITION HISTORY FROM NOTABLE
       Uses disposition_label field, matches on risk_object
       Both BP and FP shown -- BP flagged as broken in truth table
       ============================================================ -->
  <row depends="$search_entity$">
    <panel>
      <title>Disposition History -- $search_entity$ (Last 90 Days)</title>
      <table>
        <search>
          <query>`notable`
| search risk_object="$search_entity$"
| where disposition_label IN ("Benign Positive", "False Positive")
| stats count as total, latest(_time) as last_closed, values(rule_name) as rules by disposition_label
| eval last_closed=strftime(last_closed, "%Y-%m-%d %H:%M:%S"),
       warning=if(disposition_label="Benign Positive", "NOT getting suppression -- truth table bug", "OK -- suppression applied")
| sort - total
| rename disposition_label AS "Disposition", total AS "Total Closures",
         last_closed AS "Most Recent", rules AS "Rules", warning AS "Truth Table Status"</query>
          <earliest>-90d@d</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="wrap">true</option>
        <format type="color" field="Truth Table Status">
          <colorPalette type="map">{"NOT getting suppression -- truth table bug":#dc4e41,"OK -- suppression applied":#53a051}</colorPalette>
        </format>
      </table>
    </panel>

    <panel>
      <title>Weekly Disposition Volume -- $search_entity$</title>
      <chart>
        <search>
          <query>`notable`
| search risk_object="$search_entity$"
| where disposition_label IN ("Benign Positive", "False Positive")
| eval week=strftime(_time, "%Y-W%V")
| stats count by week, disposition_label
| sort week</query>
          <earliest>-90d@d</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.axisTitleX.text">Week</option>
        <option name="charting.axisTitleY.text">Dispositions</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="drilldown">none</option>
        <option name="height">220</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>

  <!-- ============================================================
       ROW 4: KV WHITELIST CHECK
       Cross-references WF02958.KV.IOC_Whitelist on value field
       Shows whether entity already has an active exclusion
       expiry stored as epoch milliseconds -- divide by 1000
       ============================================================ -->
  <row depends="$search_entity$">
    <panel>
      <title>Existing KV Exclusions for $search_entity$ (WF02958.KV.IOC_Whitelist)</title>
      <table>
        <search>
          <query>| inputlookup WF02958.KV.IOC_Whitelist
| search value="$search_entity$"
| eval expiry_epoch=expiry/1000,
       expiry_fmt=strftime(expiry_epoch, "%Y-%m-%d %H:%M:%S"),
       days_remaining=round((expiry_epoch - now()) / 86400, 0),
       exclusion_status=if(expiry_epoch > now(), "ACTIVE", "EXPIRED")
| table content field value exclusion_status expiry_fmt days_remaining ticket_no submitted_by scope notes
| rename content AS "Rule (content)", field AS "Excluded Field", value AS "IOC Value",
         exclusion_status AS "Status", expiry_fmt AS "Expires",
         days_remaining AS "Days Remaining", ticket_no AS "Ticket",
         submitted_by AS "Submitted By", scope AS "Scope", notes AS "Notes"</query>
          <earliest>-1m</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="wrap">true</option>
        <format type="color" field="Status">
          <colorPalette type="map">{"ACTIVE":#53a051,"EXPIRED":#dc4e41}</colorPalette>
        </format>
        <format type="color" field="Days Remaining">
          <colorPalette type="minMidMax" maxColor="#53a051" midColor="#f8be34" minColor="#dc4e41"></colorPalette>
          <scale type="threshold">14,30</scale>
        </format>
      </table>
      <html>
        <p style="color:#999; font-size:0.8em; padding:4px 0 0 0;">
          No results = no existing exclusion. Entity may still have a pending tuning ticket not yet reflected in KV store.
        </p>
      </html>
    </panel>
  </row>

  <!-- ============================================================
       ROW 5: FP TRACKER HISTORY FOR THIS ENTITY
       Matches on risk_object OR ioc_value (analyst may have entered
       entity as either field)
       ============================================================ -->
  <row depends="$search_entity$">
    <panel>
      <title>FP Tracker History for $search_entity$</title>
      <table>
        <search base="base_fp_data">
          <query>| search risk_object="$search_entity$" OR ioc_value="$search_entity$"
| sort - timestamp_epoch
| table timestamp analyst rule_name ioc_value ioc_type ioc_field xsoar_case reason count tuning_ticket status
| rename timestamp AS "Timestamp", analyst AS "Analyst", rule_name AS "Rule",
         ioc_value AS "IOC Value", ioc_type AS "Type", ioc_field AS "Excluded Field",
         xsoar_case AS "XSOAR Case", reason AS "Reason",
         count AS "Count", tuning_ticket AS "Tuning Ticket", status AS "Status"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="wrap">true</option>
        <format type="color" field="Status">
          <colorPalette type="map">{"open":#f8be34,"validated":#53a051,"tuned":#006d9c,"dismissed":#999999}</colorPalette>
        </format>
      </table>
      <html>
        <p style="color:#999; font-size:0.8em; padding:4px 0 0 0;">
          No results = not yet tracked in FP tracker. Use the submission form below.
        </p>
      </html>
    </panel>
  </row>

  <!-- ============================================================
       ROW 6: SUBMISSION FORM HEADER
       ============================================================ -->
  <row>
    <panel>
      <html>
        <h2 style="color:#53a051; margin:0; padding:15px 0 5px 0; border-bottom:2px solid #53a051;">
          Submit False Positive Entry
        </h2>
        <p style="color:#999; margin:5px 0 0 0; font-size:0.85em;">
          Required: IOC Value, IOC Type, IOC Field, Rule Name, Reason.
          Include XSOAR case ID -- this feeds the tuning ticket generator automatically.
          Duplicate IOC + Rule combos auto-increment count and accumulate case references.
        </p>
      </html>
    </panel>
  </row>

  <!-- ============================================================
       ROW 7: INPUT FORM
       Rule name pulls dynamically from Risk.All_Risk search_name
       IOC field dropdown mirrors WF02958.KV.IOC_Whitelist field values
       ============================================================ -->
  <row>
    <panel>

      <input type="text" token="form_ioc_value" searchWhenChanged="false">
        <label>* IOC Value (IP, domain, hash, username, hostname)</label>
        <default></default>
        <initialValue></initialValue>
      </input>

      <input type="dropdown" token="form_ioc_type" searchWhenChanged="false">
        <label>* IOC Type</label>
        <choice value="IP">IP</choice>
        <choice value="Domain">Domain</choice>
        <choice value="Hash">Hash</choice>
        <choice value="Username">Username</choice>
        <choice value="Hostname">Hostname</choice>
        <choice value="URL">URL</choice>
        <choice value="CommandLine">CommandLine</choice>
        <choice value="Other">Other</choice>
        <default>IP</default>
      </input>

      <!-- IOC Field: maps directly to the 'field' column in WF02958.KV.IOC_Whitelist
           These are the fields SCD uses when building an exclusion.
           Analyst selects what field the IOC lives in for that rule. -->
      <input type="dropdown" token="form_ioc_field" searchWhenChanged="false">
        <label>* IOC Field (field being excluded in the rule -- matches KV Whitelist 'field')</label>
        <choice value="src_ip">src_ip</choice>
        <choice value="src">src</choice>
        <choice value="dest">dest</choice>
        <choice value="domain">domain</choice>
        <choice value="domain_file">domain_file</choice>
        <choice value="url_domain">url_domain</choice>
        <choice value="url">url</choice>
        <choice value="user">user</choice>
        <choice value="user_bunit">user_bunit</choice>
        <choice value="os_user">os_user</choice>
        <choice value="hostname">hostname</choice>
        <choice value="CommandLine">CommandLine</choice>
        <choice value="event_ParentCommandLine">event_ParentCommandLine</choice>
        <choice value="ImageFileName">ImageFileName</choice>
        <choice value="file_hash">file_hash</choice>
        <choice value="file_name">file_name</choice>
        <choice value="SourceFileName">SourceFileName</choice>
        <choice value="db_app__db_user">db_app__db_user</choice>
        <choice value="asn">asn</choice>
        <choice value="src_ip_asn">src_ip_asn</choice>
        <choice value="perimeter system">perimeter system</choice>
        <choice value="other">other -- specify in reason</choice>
        <default>src_ip</default>
      </input>

      <!-- Rule name: dynamic from Risk.All_Risk datamodel
           Uses search_name which has format:
           "Category - WF#####.Rule_Name - Rule"
           No static CSV required -- always reflects current deployed rules -->
      <input type="dropdown" token="form_rule_name" searchWhenChanged="false">
        <label>* Rule Name (from Risk.All_Risk -- reflects currently deployed rules)</label>
        <search>
          <query>| from datamodel:"Risk.All_Risk"
| dedup search_name
| sort search_name
| table search_name</query>
          <earliest>-24h</earliest>
          <latest>now</latest>
        </search>
        <fieldForLabel>search_name</fieldForLabel>
        <fieldForValue>search_name</fieldForValue>
        <default></default>
      </input>

      <input type="text" token="form_risk_object" searchWhenChanged="false">
        <label>Risk Object / Entity (hostname or username from XSOAR case)</label>
        <default>$search_entity$</default>
        <initialValue>$search_entity$</initialValue>
      </input>

      <input type="text" token="form_xsoar_case" searchWhenChanged="false">
        <label>XSOAR Case / MC Incident ID (used for tuning ticket justification)</label>
        <default></default>
        <initialValue></initialValue>
      </input>

      <input type="text" token="form_reason" searchWhenChanged="false">
        <label>* Reason (why is this a FP? Include context -- feeds SCD template justification field)</label>
        <default></default>
        <initialValue></initialValue>
      </input>

      <input type="checkbox" token="form_t2_validation" searchWhenChanged="false">
        <label>Flag for T2 Review</label>
        <choice value="1">Yes -- escalate to T2 for review</choice>
        <default></default>
        <delimiter>,</delimiter>
      </input>

      <input type="text" token="form_tuning_ticket" searchWhenChanged="false">
        <label>Existing Tuning Ticket (Jira key if already submitted -- e.g. SCDCET-1234)</label>
        <default></default>
        <initialValue></initialValue>
      </input>

      <html>
        <div style="padding:8px 0;">
          <p style="color:#999; font-size:0.85em;">
            Click the search icon (magnifying glass) below to submit.
            IOC Value, IOC Type, IOC Field, Rule Name, and Reason are required.
            If this IOC+Rule combo already exists, count increments and XSOAR case is appended.
          </p>
        </div>
      </html>

      <!-- ========================================================
           SUBMISSION SEARCH
           Key: ioc_value + rule_name uniqueness
           Duplicate behavior:
             - count increments on existing row
             - xsoar_case appended (comma-separated accumulation)
             - tuning_ticket updated if provided
             - t2 flag sticky (once set, stays set)
           ======================================================== -->
      <search>
        <query>| makeresults
| eval submit_check=if(
    len("$form_ioc_value$") > 0 AND
    len("$form_rule_name$") > 0 AND
    len("$form_ioc_field$") > 0 AND
    len("$form_reason$") > 0, "valid", "invalid")
| where submit_check="valid"

| eval new_timestamp=now(),
       new_analyst="$env:user$",
       new_rule_name="$form_rule_name$",
       new_ioc_value="$form_ioc_value$",
       new_ioc_type="$form_ioc_type$",
       new_ioc_field="$form_ioc_field$",
       new_risk_object="$form_risk_object$",
       new_xsoar_case="$form_xsoar_case$",
       new_reason="$form_reason$",
       new_t2_validation_needed=if("$form_t2_validation$"="1", 1, 0),
       new_tuning_ticket="$form_tuning_ticket$",
       new_status="open"

| fields new_*

| append
    [| inputlookup fp_tracker.csv]

| eval is_new_entry=if(isnotnull(new_timestamp), 1, 0),
       match_key=if(is_new_entry=1,
         new_ioc_value . "|" . new_rule_name,
         ioc_value . "|" . rule_name)

| eventstats sum(is_new_entry) as has_new_entry by match_key
| eventstats count as match_count by match_key

| eval is_duplicate=if(is_new_entry=0 AND has_new_entry > 0 AND match_count > 1, 1, 0)

| eval count=case(
    is_new_entry=1 AND match_count > 1, null(),
    is_new_entry=1 AND match_count=1, 1,
    is_duplicate=1, count + 1,
    1=1, count),
  timestamp=case(
    is_new_entry=1 AND match_count=1, new_timestamp,
    1=1, timestamp),
  analyst=case(
    is_new_entry=1 AND match_count=1, new_analyst,
    1=1, analyst),
  rule_name=case(
    is_new_entry=1 AND match_count=1, new_rule_name,
    1=1, rule_name),
  ioc_value=case(
    is_new_entry=1 AND match_count=1, new_ioc_value,
    1=1, ioc_value),
  ioc_type=case(
    is_new_entry=1 AND match_count=1, new_ioc_type,
    1=1, ioc_type),
  ioc_field=case(
    is_new_entry=1 AND match_count=1, new_ioc_field,
    1=1, ioc_field),
  risk_object=case(
    is_new_entry=1 AND match_count=1, new_risk_object,
    1=1, risk_object),
  xsoar_case=case(
    is_new_entry=1 AND match_count=1, new_xsoar_case,
    is_duplicate=1 AND len(new_xsoar_case) > 0, xsoar_case . "," . new_xsoar_case,
    1=1, xsoar_case),
  reason=case(
    is_new_entry=1 AND match_count=1, new_reason,
    1=1, reason),
  t2_validation_needed=case(
    is_new_entry=1 AND match_count=1, new_t2_validation_needed,
    is_duplicate=1, if(new_t2_validation_needed=1, 1, t2_validation_needed),
    1=1, t2_validation_needed),
  tuning_ticket=case(
    is_new_entry=1 AND match_count=1, new_tuning_ticket,
    is_duplicate=1 AND len(new_tuning_ticket) > 0, new_tuning_ticket,
    1=1, tuning_ticket),
  status=case(
    is_new_entry=1 AND match_count=1, new_status,
    1=1, status)

| where is_new_entry=0 OR match_count=1
| fields timestamp analyst rule_name ioc_value ioc_type ioc_field risk_object xsoar_case reason count t2_validation_needed tuning_ticket status
| outputlookup fp_tracker.csv</query>
        <earliest>-1m</earliest>
        <latest>now</latest>
        <done>
          <condition match="$job.resultCount$ > 0">
            <set token="submission_status">success</set>
            <set token="form_ioc_value"></set>
            <set token="form_risk_object"></set>
            <set token="form_xsoar_case"></set>
            <set token="form_reason"></set>
            <set token="form_t2_validation"></set>
            <set token="form_tuning_ticket"></set>
          </condition>
          <condition>
            <set token="submission_status">failed</set>
          </condition>
        </done>
      </search>

      <html depends="$submission_status$">
        <div style="background-color:#53a051; color:white; padding:12px 20px; border-radius:4px; margin:10px 0; font-weight:bold; text-align:center;">
          Entry submitted. Count incremented if duplicate. Dashboard refreshing in 5 minutes.
        </div>
      </html>
    </panel>
  </row>

  <!-- ============================================================
       ROW 8: RECENT SUBMISSIONS
       ============================================================ -->
  <row>
    <panel>
      <html>
        <h2 style="color:#006d9c; margin:0; padding:15px 0 5px 0; border-bottom:2px solid #006d9c;">
          Recent Submissions (Last 15)
        </h2>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <table>
        <search base="base_fp_data">
          <query>| sort - timestamp_epoch
| head 15
| table timestamp analyst rule_name ioc_value ioc_type ioc_field risk_object xsoar_case count tuning_ticket status
| rename timestamp AS "Timestamp", analyst AS "Analyst", rule_name AS "Rule",
         ioc_value AS "IOC Value", ioc_type AS "Type", ioc_field AS "Field",
         risk_object AS "Risk Object", xsoar_case AS "XSOAR Case",
         count AS "Count", tuning_ticket AS "Ticket", status AS "Status"</query>
        </search>
        <option name="count">15</option>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <drilldown>
          <set token="drilldown_ioc">$row.IOC Value$</set>
          <set token="drilldown_rule">$row.Rule$</set>
        </drilldown>
        <format type="color" field="Status">
          <colorPalette type="map">{"open":#f8be34,"validated":#53a051,"tuned":#006d9c,"dismissed":#999999}</colorPalette>
        </format>
        <format type="color" field="Count">
          <colorPalette type="minMidMax" maxColor="#dc4e41" midColor="#f8be34" minColor="#53a051"></colorPalette>
          <scale type="threshold">5,10</scale>
        </format>
      </table>
    </panel>
  </row>

  <!-- Drilldown detail panel -->
  <row depends="$drilldown_ioc$">
    <panel>
      <title>Entry Detail: $drilldown_ioc$ / $drilldown_rule$</title>
      <table>
        <search>
          <query>| inputlookup fp_tracker.csv
| search ioc_value="$drilldown_ioc$" rule_name="$drilldown_rule$"
| eval timestamp=strftime(timestamp, "%Y-%m-%d %H:%M:%S"),
       t2_validation_needed=if(t2_validation_needed=1, "Yes", "No")
| table timestamp analyst rule_name ioc_value ioc_type ioc_field risk_object xsoar_case reason count t2_validation_needed tuning_ticket status</query>
        </search>
        <option name="drilldown">none</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

  <!-- ============================================================
       ROW 9: HIGH REPEAT OFFENDERS
       ============================================================ -->
  <row>
    <panel>
      <html>
        <h2 style="color:#dc4e41; margin:0; padding:15px 0 5px 0; border-bottom:2px solid #dc4e41;">
          High Repeat Offenders (count &gt; 5, status=open)
        </h2>
        <p style="color:#999; margin:5px 0 0 0; font-size:0.85em;">
          Red = count &gt; 10. XSOAR cases accumulated per IOC for direct use in tuning ticket justification.
        </p>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <table>
        <search base="base_fp_data">
          <query>| where count > 5 AND status="open"
| stats min(timestamp_epoch) as first_seen_e, max(timestamp_epoch) as last_seen_e,
        max(count) as count, values(analyst) as analysts,
        values(xsoar_case) as cases, values(ioc_field) as fields
        by rule_name, ioc_value, ioc_type
| eval first_seen=strftime(first_seen_e, "%Y-%m-%d"),
       last_seen=strftime(last_seen_e, "%Y-%m-%d"),
       cases_str=mvjoin(cases, ", "),
       analysts_str=mvjoin(analysts, ", "),
       fields_str=mvjoin(fields, ", ")
| sort - count
| table rule_name ioc_value ioc_type fields_str count analysts_str cases_str first_seen last_seen
| rename rule_name AS "Rule", ioc_value AS "IOC Value", ioc_type AS "Type",
         fields_str AS "Excluded Field(s)", count AS "Count",
         analysts_str AS "Analysts", cases_str AS "XSOAR Cases",
         first_seen AS "First Seen", last_seen AS "Last Seen"</query>
        </search>
        <option name="count">20</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <format type="color" field="Count">
          <colorPalette type="minMidMax" maxColor="#dc4e41" midColor="#f8be34" minColor="#f8be34"></colorPalette>
          <scale type="threshold">5,10</scale>
        </format>
      </table>
    </panel>
  </row>

  <!-- ============================================================
       ROW 10: WEEKLY VOLUME BY RULE
       Management threshold is ~15/week but not enforced.
       HIGH = peak >= 15, MEDIUM = peak >= 10, LOW = below 10
       Use this as justification data for SCD conversations.
       ============================================================ -->
  <row>
    <panel>
      <html>
        <h2 style="color:#dc4e41; margin:0; padding:15px 0 5px 0; border-bottom:2px solid #dc4e41;">
          Weekly FP Volume by Rule (Last 4 Weeks)
        </h2>
        <p style="color:#999; margin:5px 0 0 0; font-size:0.85em;">
          HIGH = peak &gt;= 15/week (management threshold). MEDIUM = 10-14. Use peak week count as the detection count for SCD tuning template field.
        </p>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <table>
        <search base="base_fp_data">
          <query>| where timestamp_epoch >= relative_time(now(), "-28d@d")
| eval week=strftime(timestamp_epoch, "%Y-W%V")
| stats count by rule_name, week
| stats max(count) as peak_week, avg(count) as avg_week, sum(count) as total_4wk by rule_name
| eval avg_week=round(avg_week, 1),
       tune_priority=case(peak_week >= 15, "HIGH", peak_week >= 10, "MEDIUM", 1=1, "LOW")
| where total_4wk > 0
| sort - peak_week
| rename rule_name AS "Rule", peak_week AS "Peak Week Count",
         avg_week AS "Avg / Week", total_4wk AS "4-Week Total",
         tune_priority AS "Tune Priority"</query>
        </search>
        <option name="count">20</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="wrap">true</option>
        <format type="color" field="Tune Priority">
          <colorPalette type="map">{"HIGH":#dc4e41,"MEDIUM":#f8be34,"LOW":#53a051}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- ============================================================
       ROW 11: TUNING TICKET GENERATOR
       Fires for entries where (count > 10 OR t2_validation_needed=1)
       AND no tuning ticket yet entered.
       Output maps directly to SCD Jira template fields (image 8):
         Title, Goal, Justification, SIEM Rule fields/values, Cases
       T2 copies this directly into the Jira. No manual data gathering.
       ============================================================ -->
  <row>
    <panel>
      <html>
        <h2 style="color:#f8be34; margin:0; padding:15px 0 5px 0; border-bottom:2px solid #f8be34;">
          Tuning Ticket Generator
        </h2>
        <p style="color:#999; margin:5px 0 0 0; font-size:0.85em;">
          Auto-generated SCD tuning template content. Fires for count &gt; 10 OR T2-flagged entries with no ticket yet.
          T2 copies these fields into the Jira template. Once submitted, enter the ticket key in the form above to suppress from this queue.
        </p>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <table>
        <search base="base_fp_data">
          <query>| where (count > 10 OR t2_validation_needed=1) AND status="open"
| where isnull(tuning_ticket) OR tuning_ticket=""
| stats
    max(count) as detection_count,
    min(timestamp_epoch) as first_seen_e,
    max(timestamp_epoch) as last_seen_e,
    values(ioc_value) as ioc_values,
    values(ioc_field) as ioc_fields,
    values(analyst) as analysts,
    values(xsoar_case) as xsoar_cases,
    values(reason) as reasons,
    values(risk_object) as risk_objects
    by rule_name
| eval first_seen=strftime(first_seen_e, "%Y-%m-%d"),
       last_seen=strftime(last_seen_e, "%Y-%m-%d"),
       ticket_title="[Exclusion]: " . rule_name,
       ticket_goal="The CTFC is requesting an exclusion on SIEM rule " . rule_name . ". Alerting count over period " . first_seen . " to " . last_seen . ": " . detection_count . " detections.",
       ticket_justification="Analyst team dispositioned this IOC as false positive " . detection_count . " times between " . first_seen . " and " . last_seen . ". Analysts: " . mvjoin(analysts, ", ") . ". Reason: " . mvjoin(reasons, " | "),
       ticket_siem_fields="Identified Rule Fields: " . mvjoin(ioc_fields, ", "),
       ticket_siem_values="Identified Rule Values: " . mvjoin(ioc_values, ", "),
       ticket_cases="XSOAR Cases: " . mvjoin(xsoar_cases, ", "),
       ticket_entities="Risk Objects: " . mvjoin(risk_objects, ", ")
| sort - detection_count
| table ticket_title ticket_goal ticket_justification ticket_siem_fields ticket_siem_values ticket_cases ticket_entities
| rename ticket_title AS "Ticket Title (SCD Template)",
         ticket_goal AS "Goal",
         ticket_justification AS "Justification For Change",
         ticket_siem_fields AS "SIEM Rule -- Identified Fields",
         ticket_siem_values AS "SIEM Rule -- Identified Values",
         ticket_cases AS "Case / Investigation Info",
         ticket_entities AS "Entities"</query>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

  <!-- ============================================================
       ROW 12: T2 VALIDATION QUEUE
       Manually flagged by analysts during submission
       Oldest first -- T2 works FIFO
       ============================================================ -->
  <row>
    <panel>
      <html>
        <h2 style="color:#f8be34; margin:0; padding:15px 0 5px 0; border-bottom:2px solid #f8be34;">
          T2 Validation Queue (Manually Flagged)
        </h2>
        <p style="color:#999; margin:5px 0 0 0; font-size:0.85em;">
          Oldest entries first. Analyst explicitly escalated these for T2 review. If not flagged by analyst, check High Repeat Offenders and Weekly Volume tables above.
        </p>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <table>
        <search base="base_fp_data">
          <query>| where t2_validation_needed=1 AND status="open"
| sort + timestamp_epoch
| table timestamp analyst rule_name ioc_value ioc_type ioc_field risk_object xsoar_case reason count tuning_ticket
| rename timestamp AS "Timestamp", analyst AS "Analyst", rule_name AS "Rule",
         ioc_value AS "IOC Value", ioc_type AS "Type", ioc_field AS "Field",
         risk_object AS "Risk Object", xsoar_case AS "XSOAR Case",
         reason AS "Reason", count AS "Count", tuning_ticket AS "Ticket"</query>
        </search>
        <option name="count">20</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

  <!-- ============================================================
       ROW 13: ANALYST SUBMISSION VOLUME
       Tracks adoption. Low numbers from specific analysts = friction
       or awareness gap, not necessarily low FP volume.
       ============================================================ -->
  <row>
    <panel>
      <html>
        <h2 style="color:#006d9c; margin:0; padding:15px 0 5px 0; border-bottom:2px solid #006d9c;">
          Analyst Submission Volume (Last 30 Days)
        </h2>
        <p style="color:#999; margin:5px 0 0 0; font-size:0.85em;">
          Use this to track adoption. If analysts are working cases but not submitting, tracker is failing its job -- investigate friction, not the analyst.
        </p>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>Submissions by Analyst</title>
      <chart>
        <search base="base_fp_data">
          <query>| where timestamp_epoch >= relative_time(now(), "-30d@d")
| stats count by analyst
| sort - count</query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.showDataLabels">all</option>
        <option name="charting.axisTitleX.text">Submissions</option>
        <option name="charting.axisTitleY.text">Analyst</option>
        <option name="charting.fieldColors">{"count":#006d9c}</option>
        <option name="charting.legend.placement">none</option>
        <option name="drilldown">none</option>
        <option name="height">250</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>

    <panel>
      <title>Daily Submission Trend (Last 30 Days)</title>
      <chart>
        <search base="base_fp_data">
          <query>| where timestamp_epoch >= relative_time(now(), "-30d@d")
| eval day=strftime(timestamp_epoch, "%Y-%m-%d")
| stats count by day
| sort day</query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.showDataLabels">all</option>
        <option name="charting.axisTitleX.text">Date</option>
        <option name="charting.axisTitleY.text">Submissions</option>
        <option name="charting.fieldColors">{"count":#006d9c}</option>
        <option name="charting.legend.placement">none</option>
        <option name="drilldown">none</option>
        <option name="height">250</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>

  <!-- ============================================================
       ROW 14: TOP RULES CHARTS
       ============================================================ -->
  <row>
    <panel>
      <title>Top 10 Rules by FP Count (All Time)</title>
      <chart>
        <search base="base_fp_data">
          <query>| stats sum(count) as total_fps by rule_name
| sort - total_fps
| head 10</query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.showDataLabels">all</option>
        <option name="charting.axisTitleX.text">FP Count</option>
        <option name="charting.axisTitleY.text">Rule</option>
        <option name="charting.fieldColors">{"total_fps":#dc4e41}</option>
        <option name="charting.legend.placement">none</option>
        <option name="drilldown">none</option>
        <option name="height">300</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>

    <panel>
      <title>FP Distribution by IOC Type</title>
      <chart>
        <search base="base_fp_data">
          <query>| stats count by ioc_type</query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.showPercent">1</option>
        <option name="drilldown">none</option>
        <option name="height">300</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>

</dashboard>
